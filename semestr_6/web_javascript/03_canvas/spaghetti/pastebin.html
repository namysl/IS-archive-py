<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ale tanki</title>
    <style>
        body {
            padding: 0;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #map {
            height: 100vh;
            width: 100vw;
        }

        #start {
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1001;
            background: rgba(0, 0, 0, 0.7);
            opacity: 1;
            transition: all .3s ease-in-out;
        }
    </style>
</head>

<body>
    <div id="start">
        <input type="number" id="playercount" placeholder="Podaj liczbe graczy!">
        <input type="submit" value="Start" onclick="startgame()">
    </div>
    <canvas id="map"></canvas>
</body>
<script>
    const canvas = document.getElementById("map");
    canvas.height = window.innerHeight;
    canvas.width = window.innerWidth;
    const ctx = canvas.getContext('2d');

    let scopeValues = {
        x: window.innerWidth / 2,
        y: window.innerHeight,
        angle: -90,
        force: 10,
    };

    let turn = 0;

    let bullet = {
        x: 0,
        y: 0,
        dt: 0,
        active: false,
        done: false
    };

    function resetBullet() {
        bullet.x = 0;
        bullet.y = 0;
        bullet.dt = 0;
        bullet.active = false;
        bullet.done = false;
        bullet.sy = 0;
        bullet.sx = 0;
    }

    function angle(v) {
        let tmp = scopeValues.angle + v;
        if (tmp >= -180 && tmp <= 0)
            scopeValues.angle = tmp
    }

    function force(v) {
        let tmp = scopeValues.force + v;
        if (tmp >= 0 && tmp <= 15)
            scopeValues.force = tmp
    }

    function moveTank(x) {

        if (tanks[turn][2] <= 0)
            return;


        tanks[turn][0] = tanks[turn][0] + x;

        let obaszar = ctx.getImageData(tanks[turn][0], 0, 1, canvas.height).data;
		console.log("OBASZAR "+obaszar);
        for(let y = obaszar.length; y >= 0; y -= 4) {
            let R = obaszar[y]; 
            let G = obaszar[y + 1];
            let B = obaszar[y + 2];
            if (R === 0 && G === 0 && B === 0) {
                tanks[turn][1] = y / 4;
                break;
            }
        }
        tanks[turn][2] = tanks[turn][2] - 1;
        moveScope(tanks[turn][0]);
    }

    let tanks = [];

    function getTanks(x) {
        while (tanks.length < x) {
            let possiblex = getRandomInt(100, canvas.width - 100);
            let blisko = false;

            for (let i = 0; i < tanks.length; i++) {
                let dl = Math.abs(tanks[i][0] - possiblex);
                if (dl < 100) {
                    blisko = true;
                }
            }

            if (!blisko) {
                let obaszar = ctx.getImageData(possiblex, 0, 1, canvas.height).data;
                for(let y = obaszar.length; y >= 0; y -= 4) {
                    let R = obaszar[y]; 
                    let G = obaszar[y + 1];
                    let B = obaszar[y + 2];
                    if (R === 0 && G === 0 && B === 0) {
                        tanks.push([possiblex, y / 4, 50]);
                        break;
                    }
                }
            }
        }
    }


    function drawTanks() {
        tanks.forEach(tank => {
            ctx.fillStyle = '#ccff00';
            ctx.fillRect(tank[0]-8, tank[1], 16, 10);
        });
    }

    function moveScope(x) {
        //let possiblex = getRandomInt(100, canvas.width - 100);
        
        let obaszar = ctx.getImageData(x, 0, 1, canvas.height).data;
		console.log(obaszar);
        for(let y = obaszar.length; y >= 0; y -= 4) {
            let R = obaszar[y]; 
            let G = obaszar[y + 1];
            let B = obaszar[y + 2];
            if (R === 0 && G === 0 && B === 0) {
                scopeValues.y = y / 4;
                scopeValues.x = x;
                break;
            }
        }
    }

    function shootBullet() {
        endTurn = false;
        let length = scopeValues.force * 10;
        let x1 = scopeValues.x + Math.cos((Math.PI / 180.0) * scopeValues.angle) * length;
        let y1 = scopeValues.y + Math.sin((Math.PI / 180.0) * scopeValues.angle) * length;
        bullet.sx = x1;
        bullet.sy = y1;
        let dly = scopeValues.y - y1;
        let dlx = scopeValues.x - x1;
        bullet.u = Math.sqrt(dlx * dlx + dly * dly);
    }

    function drawScope() {
        ctx.fillStyle = '#ff00cc';
        ctx.fillRect(scopeValues.x - 8, scopeValues.y, 16, 10);
        let length = scopeValues.force * 10;
        let x1 = scopeValues.x + Math.cos((Math.PI / 180.0) * scopeValues.angle) * length;
        let y1 = scopeValues.y + Math.sin((Math.PI / 180.0) * scopeValues.angle) * length;
        ctx.beginPath();
        ctx.moveTo(scopeValues.x, scopeValues.y)
        ctx.lineTo(x1, y1);
        ctx.closePath();
        ctx.strokeStyle = '#ff0000';
        ctx.stroke();
    }

    let holes = [];

    function drawDestroy() {
        for (let i = 0; i < holes.length; i++) {
            ctx.fillStyle = "#ffffff";
            ctx.beginPath();
            ctx.arc(holes[i][0], holes[i][1], holes[i][2], 0, 2 * Math.PI);
            ctx.fill();
        }
    }

    let endTurn = false;

    function nextTurn() {

        if (endTurn)
            return;

        if (tanks[turn] != null)
            tanks[turn][2] = 50;

        let tmp = turn+1;
        endTurn = true;
        if (tmp >= tanks.length) {
            turn = 0;
            return;
        }
        turn++;
    }

    function checkIfTankAround(x, y) {
        for (let i = 0; i < tanks.length; i++) {
            let tx = tanks[i][0];
            let ty = tanks[i][1];
            let d = Math.sqrt((tx - x)*(tx - x) + (ty - y)*(ty - y));
            if (Math.abs(d) < 25) {
                tanks.splice(i, 1);
                // tanks[i][0] = -10;
                // tanks[i][1] = -10;
            }
        }
    }

    function drawBullet() {
        if (!bullet.done) {
            bullet.y = bullet.sy + ((bullet.u * Math.sin((Math.PI / 180.0) * scopeValues.angle) * bullet.dt) + ((9.8 / 2) * (bullet.dt * bullet.dt)));
            bullet.x = bullet.sx + (bullet.u * Math.cos((Math.PI / 180.0) * scopeValues.angle) * bullet.dt)
            bullet.dt += 0.05;
        }
        //moveBullet();
        ctx.fillStyle = 'green';
        ctx.fillRect(bullet.x, bullet.y, 5, 5);

        let obaszar = ctx.getImageData(bullet.x - 2, bullet.y - 2, 5, 5).data;

        for (var i = obaszar.length; i >= 0; i -= 4) {
            if (obaszar[i + 3] > 0) {
                let R = obaszar[i]; 
                let G = obaszar[i + 1];
                let B = obaszar[i + 2];
                if ((R === 255 && G === 204 && B === 0) || (R === 204 && G === 255 && B === 0)) {
                    bullet.done = true;
                    checkIfTankAround(bullet.x, bullet.y);
                    holes.push([bullet.x, bullet.y, getRandomInt(5, 20)]);
                    nextTurn();
                    console.log(turn);
                    moveScope(tanks[turn][0]);
                }
            }
        }
    }

    let mapPoints = [];
    let np = 50;
    let stepsis = canvas.width / (np - 1);
    let displacement = 2 * stepsis;
    mapPoints[0] = canvas.height - Math.random() * (canvas.height / 1.5);
    mapPoints[np - 1] = canvas.height - Math.random() * (canvas.height / 1.5);

    function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function wariatTerenowy(ps, pe) {
        let pmid = ((pe + ps) / 2) | 0;
        if (pmid == ps)
            return;
        mapPoints[pmid] = 0.5 * (mapPoints[ps] + mapPoints[pe]) + getRandomInt(-displacement, displacement);
        wariatTerenowy(ps, pmid);
        wariatTerenowy(pmid, pe);
    }

    function startgame() {
        let liczbagraczy = document.getElementById("playercount").value;

        if(liczbagraczy < 2 || liczbagraczy > 10) {
            alert("Niepoprawana ilosc graczy!");
            return;
        }

        wariatTerenowy(0, np - 1);
        drawTerrain();

        getTanks(liczbagraczy);

        moveScope(tanks[turn][0]);

        document.addEventListener('keypress', keyboard);
        draw();
        document.getElementById("start").style.opacity = 0;
    }

    function drawTerrain() {
        for (let i = 1; i < mapPoints.length; i++) {
            ctx.beginPath();
            ctx.moveTo((i - 1) * stepsis, mapPoints[i - 1]);
            ctx.lineTo(i * stepsis, mapPoints[i]);
            ctx.lineTo(i * stepsis, canvas.height);
            ctx.lineTo((i - 1) * stepsis, canvas.height);
            ctx.closePath();
            ctx.strokeStyle = '#FFCC00';
            ctx.stroke();
            ctx.fillStyle = "#FFCC00";
            ctx.fill();
        }
    }
    
    let prompted = false;

    function draw() {
        ctx.clearRect(0, 0, map.width, map.height);
        drawTerrain();
        drawDestroy();
        drawTanks();

        drawScope();
        if (bullet.active)
            drawBullet();

        if (tanks.length <= 1 && !prompted) {
            prompted = true;
            alert("Wygrana!");
            if (confirm("Restart?") == true) {
                window.location.reload();
            }
        }

        window.requestAnimationFrame(draw);
    }

    function keyboard(e) {
        let button = e.code;

        if (button === 'KeyZ')
            moveTank(-1);        

        if (button === 'KeyC')
            moveTank(1);

        if (button === 'KeyA')
            angle(-1);

        if (button === 'KeyD')
            angle(1);

        if (button === 'KeyW')
            force(1)

        if (button === 'KeyS')
            force(-1)

        if (button === 'KeyX') {
            if (bullet.active) {
                resetBullet();
            }
            bullet.active = !bullet.active
            shootBullet();
        }
    }
</script>